---
title: "API - Summary"
author: "Harpreet Kaur"
date: "12/02/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#libraries imported
library(httr)
library(jsonlite)
library(dplyr)
library(lubridate)
library(testthat)
```


```{r}

request_fun <- function(){
#' @title Make Request to API url for content extraction
#' 
#' @description The function will pass a get request to the url mentioned in the function and help in accessing the json/xml/html content of the web page. If the returned response code is 200 that means everything is good.
#' @param is none
#' 
#' @returns the response 
#' @example url = 'https://api.opencovid.ca/summary'
#' 
  url <- 'https://api.opencovid.ca/summary'
  request <- GET(url)
  return(request)
}

```

```{r}
summary_of_active_cases <- function(provinceName = 'Canada'){
  
  #' @title Every province`s summary of Covid-19 for a particular day or when the document is created.
  #'
  #' @description Summary for all the provinces relating to Covid-19 active cases, avaccine, cvaccine and dvaccine. Moreover, is discloses the count of people who have recovered and who were tested.
  #' It processes the API and returns the data corresponding to one province which is passed on as the argument. If user passes empty      
  #' argument, so by default Canada is used which returns the data of whole Canada as a  whole.
  #' The returned data is a data frame and contains the columns including the date, province name, active cases, change is active cases,
  #' cumulative cases, cumulative deaths and cumulative recovered.
  #'
  #' @param provinceName a character/string depicting the name of the province
  #'
  #' @return Data frame for the Covid-19 active cases  corresponding to a particular province
  #'
  #' @examples summary_of_active_cases("Ontario")
  
  prov = c("Alberta", "British Columbia", "Manitoba", "New Brunswick", "Newfoundland and Labrador", "Nova Scotia", "Nunavut", "Northwest Territories", "Ontario", "Prince Edward Island", "Quebec", "Saskatchewan", "Yukon", "Canada")
  
  `%!in%` <- Negate(`%in%`) 
  if(tolower(provinceName) %!in% tolower(prov)){
    stop("Please enter a valid province name in full form!")
  }
  
  request <- request_fun()
  json_data <- content(request, as  = "parse")
  all_active <- json_data$active
  active_data <- data.frame()
  
  #print(json_data[[1]])
  for(i in 1:length(json_data[[1]])){

    active_data <- rbind(active_data, data.frame(json_data[[1]][[i]]))
  }
  
  
  active_data <- active_data %>%
    mutate(date, date = dmy(date)) %>%
    mutate(province = replace(province, province %in% c("BC"), "British Columbia"),
           province = replace(province, province %in% c("NL"), "Newfoundland and Labrador"),
           province = replace(province, province %in% c("NWT"), "Northwest Territories"),
           province = replace(province, province %in% c("PEI"), "Prince Edward Island"))
  
  
  active_data <- active_data[,c(13,16,1:12,14:15,17:19)]
  print(active_data)
  if(tolower(provinceName) == "canada"){
    return(active_data)
  } else {
    active_data <- active_data %>%
      filter(tolower(province) == tolower(provinceName))
    return(active_data)
  }
  
}


data <- summary_of_active_cases('ALBERTA')
```









